#parameters:
#  - name: buildConfiguration
#    displayName: 'Build Configuration'
#    type: string
#    default: 'Release'
#    values:
#      - Release
#      - Debug

#  - name: backendProjectPath
#    displayName: 'Backend project path'
#    type: string
#    default: './MangoAPI.Presentation/MangoAPI.Presentation.csproj'

jobs:
  - job: 'SonarCloud_Analyzer'
    displayName: 'SonarCloud Static Code Analyzer'
    steps:
      - task: gitversion/setup@0
        displayName: 'GitVersion Setup'
        inputs:
          versionSpec: '5.9.x'

      - task: gitversion/execute@0
        displayName: 'GitVersion Execute'
        inputs:
          updateAssemblyInfo: true

      - bash: echo $Action$BuildVersion
        displayName: 'Set Build Version'
        env:
          Action: '##vso[build.updatebuildnumber]'
          BuildVersion: $(GitVersion.SemVer)

      - task: SonarCloudPrepare@1
        displayName: 'Prepare SonarCloud'
        inputs:
          SonarCloud: 'SonarCloud_Mango'
          organization: 'mangoinstantmessenger'
          scannerMode: 'MSBuild'
          projectKey: 'MangoInstantMessenger_MangoMessengerAPI'
          projectName: 'MangoMessengerAPI'
          projectVersion: '$(GitVersion.SemVer)'
          extraProperties: |
            sonar.cs.vstest.reportsPaths=$(Agent.TempDirectory)/**/*.trx
            sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/**/*opencover.xml

      - task: DotNetCoreCLI@2
        displayName: 'Dotnet restore'
        inputs:
          command: 'restore'
          projects: '${{ parameters.integrationTestsProjectPath }}'
          arguments: '--verbosity minimal'

      - task: DotNetCoreCLI@2
        displayName: 'Dotnet build ${{ parameters.buildConfiguration }}'
        inputs:
          command: 'build'
          projects: '${{ parameters.integrationTestsProjectPath }}'
          arguments: '--configuration ${{ parameters.buildConfiguration }} --no-restore'

      - task: SonarCloudAnalyze@1
        displayName: 'Run Code Analysis'

      - task: SonarCloudPublish@1
        displayName: 'Publish Quality Gate Results'
